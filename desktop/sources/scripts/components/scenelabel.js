//  Created by Devine Lu Linvega.
//  Copyright © 2017 XXIIVV. All rights reserved.

class SceneLabel extends SceneLine {
  constructor (
    text = '',
    scale = 0.1,
    align = Alignment.left,
    color = verreciel.white
  ) {
    // assertArgs(arguments, 1);
    super([], color)

    this.activeText = text
    this.activeScale = scale
    this.activeAlignment = align
    this.material.lineWidth = 0.003
    this.redrawLetters(this.activeText, this.activeScale)
  }

  updateText (text, color = null) {
    // assertArgs(arguments, 1);

    if (text == null) {
      text = this.activeText
    }

    if (color == null) {
      color = this.color
    }

    if (this.activeText != text || !this.color.equals(color)) {
      this.activeText = text
      this.color = color
      this.redrawLetters(this.activeText, this.activeScale)
    }
  }

  updateScale (scale) {
    // assertArgs(arguments, 1);
    if (this.activeScale != scale) {
      this.activeScale = scale
      this.redrawLetters(this.activeText, this.activeScale)
    }
  }

  redrawLetters (text, scale) {
    const lineHeight = 1.5
    const letterSpacing = 0.3

    let line = 0
    let offset = 0
    let vertices = []
    let glyph = null

    // NOTE: We need to upscale here, as the new glyphs
    // are considerably smaller, and don't have negative coordinates.
    scale *= 1.5
    text = `${text}`.toLowerCase()

    for (let i = 0; i < text.length; i++) {
      if (text[i] === '$' || text[i] === '\n') {
        line += 1
        offset = 0
        continue
      }

      glyph = SceneLabel.glyphs[text[i]]

      if (glyph == null) {
        console.warn(`Unmapped glyph "${text[i]}"`)
        continue
      }

      this.appendLetter(vertices, glyph, scale, offset, line * -lineHeight)

      offset += glyph.width + letterSpacing
    }

    this.updateVertices(vertices)

    // Calculate the bounding box of the resulting mesh,
    // and use that to center it over its origin, or align it.
    let segments = this.meshLineSegments

    segments.geometry.computeBoundingBox()
    segments.mesh.position.y = -segments.geometry.boundingBox.max.y / 2

    if (this.activeAlignment === Alignment.center) {
      segments.mesh.position.x = -segments.geometry.boundingBox.max.x / 2
    } else if (this.activeAlignment === Alignment.right) {
      segments.mesh.position.x = -segments.geometry.boundingBox.max.x
    }
  }

  appendLetter (vertices, glyph, scale, offsetX, offsetY) {
    let vertex = null

    for (let coords of glyph.positions) {
      vertex = new THREE.Vector3(coords[0], coords[1], 0.0)
      vertex.x = vertex.x + offsetX
      vertex.y = vertex.y + offsetY
      vertex.multiplyScalar(scale)
      vertices.push(vertex)
    }
  }
}

SceneLabel.glyphs = {
  a: {
    width: 0.8,
    positions: [
      [0.0, 0.0],
      [0.3, 1.0],
      [0.3, 1.0],
      [0.5, 1.0],
      [0.5, 1.0],
      [0.8, 0.0],
      [0.65, 0.4],
      [0.15, 0.4]
    ]
  },
  b: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 1.0],
      [0.45, 1.0],
      [0.45, 1.0],
      [0.55, 0.9],
      [0.55, 0.9],
      [0.55, 0.6],
      [0.55, 0.6],
      [0.45, 0.5],
      [0.45, 0.5],
      [0.0, 0.5],
      [0.45, 0.5],
      [0.6, 0.4],
      [0.6, 0.4],
      [0.6, 0.1],
      [0.6, 0.1],
      [0.5, 0.0],
      [0.5, 0.0],
      [0.0, 0.0]
    ]
  },
  c: {
    width: 0.6,
    positions: [
      [0.6, 0.9],
      [0.5, 1.0],
      [0.5, 1.0],
      [0.2, 1.0],
      [0.2, 1.0],
      [0.0, 0.8],
      [0.0, 0.8],
      [0.0, 0.2],
      [0.0, 0.2],
      [0.2, 0.0],
      [0.2, 0.0],
      [0.5, 0.0],
      [0.5, 0.0],
      [0.6, 0.1]
    ]
  },
  d: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 1.0],
      [0.45, 1.0],
      [0.45, 1.0],
      [0.6, 0.8],
      [0.6, 0.8],
      [0.6, 0.2],
      [0.6, 0.2],
      [0.45, 0.0],
      [0.45, 0.0],
      [0.0, 0.0]
    ]
  },
  e: {
    width: 0.5,
    positions: [
      [0.5, 0.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.0, 0.12],
      [0.0, 0.12],
      [0.0, 0.88],
      [0.0, 0.88],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.5, 1.0],
      [0.0, 0.5],
      [0.4, 0.5]
    ]
  },
  f: {
    width: 0.5,
    positions: [
      [0.0, 0.0],
      [0.0, 0.88],
      [0.0, 0.88],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.5, 1.0],
      [0.0, 0.5],
      [0.4, 0.5]
    ]
  },
  g: {
    width: 0.8,
    positions: [
      [0.2, 0.0],
      [0.0, 0.2],
      [0.0, 0.2],
      [0.0, 0.8],
      [0.0, 0.8],
      [0.2, 1.0],
      [0.2, 1.0],
      [0.6, 1.0],
      [0.6, 1.0],
      [0.7, 0.9],
      [0.6, 0.0],
      [0.2, 0.0],
      [0.6, 0.0],
      [0.8, 0.2],
      [0.8, 0.2],
      [0.8, 0.5],
      [0.8, 0.5],
      [0.5, 0.5]
    ]
  },
  h: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 0.5],
      [0.6, 0.5],
      [0.6, 0.0],
      [0.6, 1.0]
    ]
  },
  i: {
    width: 0.4,
    positions: [
      [0.2, 0.0],
      [0.2, 1.0],
      [0.0, 0.0],
      [0.4, 0.0],
      [0.0, 1.0],
      [0.4, 1.0]
    ]
  },
  j: {
    width: 0.2,
    positions: [
      [0.0, 1.0],
      [0.2, 1.0],
      [0.2, 1.0],
      [0.2, 0.0],
      [0.2, 0.0],
      [0.1, -0.1],
      [0.1, -0.1],
      [0.0, -0.1]
    ]
  },
  k: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 0.4],
      [0.55, 1.0],
      [0.2, 0.6],
      [0.6, 0.0]
    ]
  },
  l: {
    width: 0.6,
    positions: [[0.0, 0.0], [0.0, 1.0], [0.0, 0.0], [0.6, 0.0]]
  },
  m: {
    width: 0.9,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 1.0],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.5, 0.0],
      [0.5, 0.0],
      [0.8, 1.0],
      [0.8, 1.0],
      [0.9, 1.0],
      [0.9, 1.0],
      [0.9, 0.0]
    ]
  },
  n: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 1.0],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.5, 0.0],
      [0.5, 0.0],
      [0.6, 0.0],
      [0.6, 0.0],
      [0.6, 1.0]
    ]
  },
  o: {
    width: 0.8,
    positions: [
      [0.2, 0.0],
      [0.0, 0.2],
      [0.0, 0.2],
      [0.0, 0.8],
      [0.0, 0.8],
      [0.2, 1.0],
      [0.2, 1.0],
      [0.6, 1.0],
      [0.6, 1.0],
      [0.8, 0.8],
      [0.8, 0.8],
      [0.8, 0.2],
      [0.8, 0.2],
      [0.6, 0.0],
      [0.6, 0.0],
      [0.2, 0.0]
    ]
  },
  p: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 1.0],
      [0.5, 1.0],
      [0.5, 1.0],
      [0.6, 0.9],
      [0.6, 0.9],
      [0.6, 0.6],
      [0.6, 0.6],
      [0.5, 0.5],
      [0.5, 0.5],
      [0.0, 0.5]
    ]
  },
  q: {
    width: 0.9,
    positions: [
      [0.2, 0.0],
      [0.0, 0.2],
      [0.0, 0.2],
      [0.0, 0.8],
      [0.0, 0.8],
      [0.2, 1.0],
      [0.2, 1.0],
      [0.6, 1.0],
      [0.6, 1.0],
      [0.8, 0.8],
      [0.8, 0.8],
      [0.8, 0.2],
      [0.8, 0.2],
      [0.6, 0.0],
      [0.6, 0.0],
      [0.2, 0.0],
      [0.7, 0.1],
      [0.9, -0.1]
    ]
  },
  r: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.0, 1.0],
      [0.0, 1.0],
      [0.5, 1.0],
      [0.5, 1.0],
      [0.6, 0.9],
      [0.6, 0.9],
      [0.6, 0.6],
      [0.6, 0.6],
      [0.5, 0.5],
      [0.5, 0.5],
      [0.0, 0.5],
      [0.4, 0.5],
      [0.6, 0.0]
    ]
  },
  s: {
    width: 0.6,
    positions: [
      [0.0, 0.0],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.6, 0.15],
      [0.6, 0.15],
      [0.6, 0.4],
      [0.6, 0.4],
      [0.0, 0.65],
      [0.0, 0.65],
      [0.0, 0.85],
      [0.0, 0.85],
      [0.2, 1.0],
      [0.2, 1.0],
      [0.55, 1.0]
    ]
  },
  t: {
    width: 0.6,
    positions: [[0.3, 0.0], [0.3, 1.0], [0.0, 1.0], [0.6, 1.0]]
  },
  u: {
    width: 0.6,
    positions: [
      [0.0, 1.0],
      [0.0, 0.1],
      [0.0, 0.1],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.5, 0.0],
      [0.5, 0.0],
      [0.6, 0.1],
      [0.6, 0.1],
      [0.6, 1.0]
    ]
  },
  v: {
    width: 0.6,
    positions: [
      [0.0, 1.0],
      [0.25, 0.0],
      [0.25, 0.0],
      [0.35, 0.0],
      [0.35, 0.0],
      [0.6, 1.0]
    ]
  },
  w: {
    width: 0.9,
    positions: [
      [0.0, 1.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.2, 0.0],
      [0.2, 0.0],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.5, 1.0],
      [0.5, 1.0],
      [0.7, 0.0],
      [0.7, 0.0],
      [0.8, 0.0],
      [0.8, 0.0],
      [0.9, 1.0]
    ]
  },
  x: {
    width: 0.6,
    positions: [[0.0, 0.0], [0.6, 1.0], [0.0, 1.0], [0.6, 0.0]]
  },
  y: {
    width: 0.6,
    positions: [
      [0.0, 1.0],
      [0.2, 0.4],
      [0.2, 0.4],
      [0.4, 0.4],
      [0.4, 0.4],
      [0.6, 1.0],
      [0.3, 0.4],
      [0.3, 0.0]
    ]
  },
  z: {
    width: 0.6,
    positions: [
      [0.0, 1.0],
      [0.6, 1.0],
      [0.6, 1.0],
      [0.6, 0.8],
      [0.6, 0.8],
      [0.0, 0.2],
      [0.0, 0.2],
      [0.0, 0.0],
      [0.0, 0.0],
      [0.6, 0.0]
    ]
  },
  '0': {
    width: 0.5,
    positions: [
      [0.0, 0.9],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.5, 0.9],
      [0.5, 0.9],
      [0.5, 0.1],
      [0.5, 0.1],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.0, 0.1],
      [0.0, 0.1],
      [0.0, 0.9],
      [0.0, 0.1],
      [0.5, 0.9]
    ]
  },
  '1': {
    width: 0.55,
    positions: [[0.0, 0.9], [0.3, 1.0], [0.3, 1.0], [0.3, 0.0]]
  },
  '2': {
    width: 0.55,
    positions: [
      [0.55, 0.0],
      [0.0, 0.0],
      [0.0, 0.0],
      [0.0, 0.3],
      [0.0, 0.3],
      [0.5, 0.65],
      [0.5, 0.65],
      [0.5, 0.9],
      [0.5, 0.9],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.0, 0.9]
    ]
  },
  '3': {
    width: 0.55,
    positions: [
      [0.0, 0.9],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.5, 0.9],
      [0.5, 0.9],
      [0.5, 0.7],
      [0.5, 0.7],
      [0.4, 0.6],
      [0.4, 0.6],
      [0.2, 0.6],
      [0.4, 0.6],
      [0.5, 0.5],
      [0.5, 0.5],
      [0.5, 0.1],
      [0.5, 0.1],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.0, 0.1]
    ]
  },
  '4': {
    width: 0.55,
    positions: [
      [0.4, 0.0],
      [0.4, 1.0],
      [0.0, 0.3],
      [0.55, 0.3],
      [0.0, 0.3],
      [0.0, 0.35],
      [0.0, 0.35],
      [0.3, 1.0],
      [0.3, 1.0],
      [0.4, 1.0]
    ]
  },
  '5': {
    width: 0.55,
    positions: [
      [0.1, 1.0],
      [0.45, 1.0],
      [0.0, 0.55],
      [0.1, 1.0],
      [0.5, 0.1],
      [0.5, 0.4],
      [0.5, 0.1],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.0, 0.1],
      [0.05, 0.5],
      [0.4, 0.5],
      [0.05, 0.5],
      [0.0, 0.55],
      [0.5, 0.4],
      [0.4, 0.5]
    ]
  },
  '6': {
    width: 0.55,
    positions: [
      [0.0, 0.9],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.5, 0.9],
      [0.0, 0.1],
      [0.0, 0.9],
      [0.5, 0.1],
      [0.5, 0.4],
      [0.5, 0.1],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.0, 0.1],
      [0.0, 0.4],
      [0.2, 0.5],
      [0.2, 0.5],
      [0.4, 0.5],
      [0.5, 0.4],
      [0.4, 0.5]
    ]
  },
  '7': {
    width: 0.55,
    positions: [[0.0, 1.0], [0.4, 1.0], [0.4, 1.0], [0.15, 0.0]]
  },
  '8': {
    width: 0.55,
    positions: [
      [0.0, 0.9],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.5, 0.9],
      [0.5, 0.4],
      [0.5, 0.1],
      [0.5, 0.6],
      [0.5, 0.9],
      [0.5, 0.1],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.0, 0.1],
      [0.0, 0.9],
      [0.0, 0.6],
      [0.0, 0.4],
      [0.0, 0.1],
      [0.0, 0.6],
      [0.1, 0.5],
      [0.0, 0.4],
      [0.1, 0.5],
      [0.1, 0.5],
      [0.4, 0.5],
      [0.4, 0.5],
      [0.5, 0.6],
      [0.5, 0.4],
      [0.4, 0.5]
    ]
  },
  '9': {
    width: 0.55,
    positions: [
      [0.0, 0.9],
      [0.1, 1.0],
      [0.1, 1.0],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.5, 0.9],
      [0.5, 0.9],
      [0.5, 0.1],
      [0.5, 0.1],
      [0.4, 0.0],
      [0.4, 0.0],
      [0.1, 0.0],
      [0.1, 0.0],
      [0.0, 0.1],
      [0.0, 0.9],
      [0.0, 0.6],
      [0.0, 0.6],
      [0.1, 0.5],
      [0.1, 0.5],
      [0.3, 0.5],
      [0.3, 0.5],
      [0.5, 0.6]
    ]
  },
  ':': {
    width: 1.0,
    positions: [[0.5, 0.6], [0.5, 0.7], [0.5, 0.4], [0.5, 0.3]]
  },
  ' ': {
    width: 0.3,
    positions: []
  },
  '~': {
    width: 1.0,
    positions: [[0.0, 0.0], [0.0, 0.0]]
  },
  '/': {
    width: 1.0,
    positions: [[0.2, -0.1], [0.8, 1.1]]
  },
  '-': {
    width: 1.0,
    positions: [[0.2, 0.5], [0.8, 0.5]]
  },
  _: {
    width: 1.0,
    positions: [[0.1, 0.0], [0.9, 0.0]]
  },
  '&': {
    width: 1.0,
    positions: [[0.0, 0.0], [0.0, 0.0]]
  },
  '+': {
    width: 1.0,
    positions: [[0.2, 0.5], [0.8, 0.5], [0.5, 0.8], [0.5, 0.2]]
  },
  '*': {
    width: 1.0,
    positions: [
      [0.25, 0.35],
      [0.75, 0.65],
      [0.25, 0.65],
      [0.75, 0.35],
      [0.5, 0.8],
      [0.5, 0.2]
    ]
  },
  '>': {
    width: 1.0,
    positions: [
      [0.2, 0.8],
      [0.8, 0.55],
      [0.8, 0.55],
      [0.8, 0.45],
      [0.8, 0.45],
      [0.2, 0.2]
    ]
  },
  '<': {
    width: 1.0,
    positions: [
      [0.8, 0.8],
      [0.2, 0.55],
      [0.2, 0.55],
      [0.2, 0.45],
      [0.2, 0.45],
      [0.8, 0.2]
    ]
  },
  '[': {
    width: 1.0,
    positions: [
      [0.6, 1.2],
      [0.6, -0.2],
      [0.8, 1.2],
      [0.6, 1.2],
      [0.8, -0.2],
      [0.6, -0.2]
    ]
  },
  ']': {
    width: 1.0,
    positions: [
      [0.4, 1.2],
      [0.4, -0.2],
      [0.4, 1.2],
      [0.2, 1.2],
      [0.4, -0.2],
      [0.2, -0.2]
    ]
  },
  '(': {
    width: 1.0,
    positions: [
      [0.6, 1.1],
      [0.6, -0.1],
      [0.8, 1.2],
      [0.6, 1.1],
      [0.8, -0.2],
      [0.6, -0.1]
    ]
  },
  ')': {
    width: 1.0,
    positions: [
      [0.4, 1.1],
      [0.4, -0.1],
      [0.4, 1.1],
      [0.2, 1.2],
      [0.4, -0.1],
      [0.2, -0.2]
    ]
  },
  '{': {
    width: 1.0,
    positions: [
      [0.8, 1.2],
      [0.6, 1.1],
      [0.6, 1.1],
      [0.6, 0.6],
      [0.6, 0.6],
      [0.5, 0.5],
      [0.5, 0.5],
      [0.6, 0.4],
      [0.6, 0.4],
      [0.6, -0.1],
      [0.6, -0.1],
      [0.8, -0.2]
    ]
  },
  '}': {
    width: 1.0,
    positions: [
      [0.2, 1.2],
      [0.4, 1.1],
      [0.4, 1.1],
      [0.4, 0.6],
      [0.4, 0.6],
      [0.5, 0.5],
      [0.5, 0.5],
      [0.4, 0.4],
      [0.4, 0.4],
      [0.4, -0.1],
      [0.4, -0.1],
      [0.2, -0.2]
    ]
  },
  ',': {
    width: 1.0,
    positions: [[0.5, 0.1], [0.5, 0.0], [0.5, 0.0], [0.4, -0.1]]
  },
  '!': {
    width: 1.0,
    positions: [[0.5, 1.0], [0.5, 0.3], [0.5, 0.1], [0.5, 0.0]]
  },
  '?': {
    width: 1.0,
    positions: [
      [0.3, 0.9],
      [0.4, 1.0],
      [0.4, 1.0],
      [0.6, 1.0],
      [0.6, 1.0],
      [0.7, 0.9],
      [0.7, 0.9],
      [0.7, 0.6],
      [0.7, 0.6],
      [0.5, 0.5],
      [0.5, 0.5],
      [0.5, 0.3],
      [0.5, 0.1],
      [0.5, 0.0]
    ]
  },
  '.': {
    width: 1.0,
    positions: [[0.5, 0.0], [0.5, 0.1]]
  },
  "'": {
    width: 1.0,
    positions: [[0.5, 1.0], [0.5, 0.8]]
  },
  '"': {
    width: 1.0,
    positions: [[0.6, 1.1], [0.6, 0.9], [0.4, 1.1], [0.4, 0.9]]
  },
  '%': {
    width: 1.0,
    positions: [
      [0.1, 0.7],
      [0.1, 0.9],
      [0.1, 0.9],
      [0.2, 1.0],
      [0.2, 1.0],
      [0.3, 1.0],
      [0.3, 1.0],
      [0.4, 0.9],
      [0.4, 0.9],
      [0.4, 0.7],
      [0.4, 0.7],
      [0.3, 0.6],
      [0.3, 0.6],
      [0.2, 0.6],
      [0.2, 0.6],
      [0.1, 0.7],
      [0.2, -0.1],
      [0.8, 1.1],
      [0.7, 0.0],
      [0.6, 0.1],
      [0.6, 0.1],
      [0.6, 0.3],
      [0.6, 0.3],
      [0.7, 0.4],
      [0.7, 0.4],
      [0.8, 0.4],
      [0.8, 0.4],
      [0.9, 0.3],
      [0.9, 0.3],
      [0.9, 0.1],
      [0.9, 0.1],
      [0.8, 0.0],
      [0.8, 0.0],
      [0.7, 0.0]
    ]
  },
  '⨉': {
    width: 1.0,
    positions: [[0.2, 0.8], [0.8, 0.2], [0.8, 0.8], [0.2, 0.2]]
  }
}
